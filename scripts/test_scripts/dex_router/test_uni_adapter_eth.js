const { ethers } = require("hardhat");
require("../../tools");
const { getConfig } = require("../../config");
const { setForkBlockNumber } = require("../../tools/chain");
tokenConfig = getConfig("eth")
const { initDexRouter, direction, FOREVER, ETH } = require("./utils")

async function executeWETH2RND() {

    // await setForkBlockNumber(10477965);

    // USDC shark
    // const accountAddress = "0x47ac0Fb4F2D84898e4D9E7b4DaB3C24507a6D503";

    // WBTC shark
    const accountAddress = "0xB60C61DBb7456f024f9338c739B02Be68e3F545C";

    // WETH Shark
    // const accountAddress = "0xBE0eB53F46cd790Cd13851d5EFf43D12404d33E8";
    
    await startMockAccount([accountAddress]);
    const account = await ethers.getSigner(accountAddress);

    // 
    await setBalance(accountAddress, "0x53444835ec58000000");

    WETH = await ethers.getContractAt(
        "MockERC20",
        "0x1f9840a85d5af5bf1d1762f925bdaddc4201f984"
    )
    USDT = await ethers.getContractAt(
        "MockERC20",
        "0x0bc529c00c6401aef6d220be8c6ea1667f6ad93e"
    )
    tokenApprove = await ethers.getContractAt(
        "TokenApprove",
        "0x40aA958dd87FC8305b97f2BA922CDdCa374bcD7f"
    );
    dexRouter = await ethers.getContractAt(
        "DexRouter",
        "0x3b3ae790Df4F312e745D270119c6052904FB6790"
    );
    univ2Adapter = await ethers.getContractAt(
        "UniV3Adapter",
        "0x03F911AeDc25c770e701B8F563E8102CfACd62c0"
    );

    // const fromTokenAmount = ethers.utils.parseUnits('100', 18);
    // const minReturnAmount = 0;
    // const deadLine = FOREVER;
    const uniV2PoolAddr = "0x703b120f15ab77b986a24c6f9262364d02f9432f"; // USDT-WETH Pool
    console.log("before WETH Balance: " + await WETH.balanceOf(account.address));
    const before = await USDT.balanceOf(account.address);
    console.log("before USDT Balance: " + await USDT.balanceOf(account.address));

    // node1
    // const mixAdapter1 = [
    //     univ2Adapter.address
    // ];
    // const assertTo1 = [
    //     uniV2PoolAddr
    // ];
    // const weight1 = Number(10000).toString(16).replace('0x', '');
    // const rawData1 = [
    //     "0x" +
    //     direction(WETH.address, USDT.address) +
    //     "0000000000000000000" +
    //     weight1 +
    //     uniV2PoolAddr.replace("0x", "")  // USDT-WETH Pool
    // ];
    // const moreInfo = 0x0
    // const extraData1 = [moreInfo];
    // const router1 = [mixAdapter1, assertTo1, rawData1, extraData1, USDT.address];

    // // layer1
    // const layer1 = [router1];

    // const baseRequest = [
    //     USDT.address,
    //     ETH.address,
    //     fromTokenAmount,
    //     minReturnAmount,
    //     deadLine,
    // ]

    r = await WETH.connect(account).approve(tokenApprove.address, ethers.constants.MaxUint256);
    beforeBalance = await ethers.provider.getBalance(accountAddress);
    console.log("ETH BeforeBalance: " + beforeBalance);

    // rxResult = await dexRouter.connect(account).smartSwap(
    //     baseRequest,
    //     [fromTokenAmount],
    //     [layer1],
    //     []
    // );
    // console.log(rxResult.data);
    
    const tx = {
        from: accountAddress,
        to: dexRouter.address,
        nonce: ethers.provider.getTransactionCount(accountAddress, "latest"),
        value: "0x056bc75e2d63100000",
        data: "0xce8c43160000000000000000000000001f9840a85d5af5bf1d1762f925bdaddc4201f9840000000000000000000000000bc529c00c6401aef6d220be8c6ea1667f6ad93e00000000000000000000000000000000000000000000021e19e0c9bab24000000000000000000000000000000000000000000000000000003a7cd015956ee420000000000000000000000000000000000000000000000000000000006273a61e000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001800000000000000000000000000000000000000000000000000000000000000fa000000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000001969368974c05b0000000000000000000000000000000000000000000000000006c6b935b8bbd3b6c2000000000000000000000000000000000000000000000001b1ae4d6e2ef4eee9000000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000052000000000000000000000000000000000000000000000000000000000000009400000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000002c000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000001600000000000000000000000001f9840a85d5af5bf1d1762f925bdaddc4201f984000000000000000000000000000000000000000000000000000000000000000100000000000000000000000003f911aedc25c770e701b8f563e8102cfacd62c0000000000000000000000000000000000000000000000000000000000000000100000000000000000000000003f911aedc25c770e701b8f563e8102cfacd62c000000000000000000000000000000000000000000000000000000000000000010000000000000000000027101d42064fc4beb5f8aaf85f4617ae8b3b5b8bd8010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000600000000000000000000000001f9840a85d5af5bf1d1762f925bdaddc4201f984000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000000000000000000000000000000000000000000bb800000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000160000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000000000000000000000000000000000000000000001000000000000000000000000c837bbea8c7b0cac0e8928f797ceb04a34c9c06e0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000088ee5007c98a9677165d78dd2109ae4a3d04d0c0000000000000000000000000000000000000000000000000000000000000001800000000000000000002710088ee5007c98a9677165d78dd2109ae4a3d04d0c000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000001600000000000000000000000001f9840a85d5af5bf1d1762f925bdaddc4201f9840000000000000000000000000000000000000000000000000000000000000001000000000000000000000000c837bbea8c7b0cac0e8928f797ceb04a34c9c06e0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000d3d2e2692501a5c9ca623199d38826e513033a170000000000000000000000000000000000000000000000000000000000000001000000000000000000002710d3d2e2692501a5c9ca623199d38826e513033a17000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000160000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000000000000000000000000000000000000000000001000000000000000000000000c837bbea8c7b0cac0e8928f797ceb04a34c9c06e00000000000000000000000000000000000000000000000000000000000000010000000000000000000000002fdbadf3c4d5a8666bc06645b8358ab803996e2800000000000000000000000000000000000000000000000000000000000000018000000000000000000027102fdbadf3c4d5a8666bc06645b8358ab803996e28000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000001600000000000000000000000001f9840a85d5af5bf1d1762f925bdaddc4201f9840000000000000000000000000000000000000000000000000000000000000001000000000000000000000000c837bbea8c7b0cac0e8928f797ceb04a34c9c06e0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000dafd66636e2561b0284edde37e42d192f2844d400000000000000000000000000000000000000000000000000000000000000001000000000000000000002710dafd66636e2561b0284edde37e42d192f2844d40000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000160000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000000000000000000000000000000000000000000100000000000000000000000003f911aedc25c770e701b8f563e8102cfacd62c0000000000000000000000000000000000000000000000000000000000000000100000000000000000000000003f911aedc25c770e701b8f563e8102cfacd62c0000000000000000000000000000000000000000000000000000000000000000180000000000000000000271004916039b1f59d9745bf6e0a21f191d1e0a842870000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000060000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000000bc529c00c6401aef6d220be8c6ea1667f6ad93e0000000000000000000000000000000000000000000000000000000000000bb80000000000000000000000000000000000000000000000000000000000000000"
    };
    rxResult = await account.sendTransaction(
        tx
    );
    // console.log(rxResult);

    gasCost = await getTransactionCost(rxResult);
    console.log("gasCost: " + gasCost);
    afterBalance = await ethers.provider.getBalance(accountAddress);
    console.log("ETH AfterBalance: " + afterBalance);
    console.log("Result: " + ethers.BigNumber.from(afterBalance).add(ethers.BigNumber.from(gasCost).sub(ethers.BigNumber.from(beforeBalance))).toString());
    console.log("after WETH Balance: " + await WETH.balanceOf(account.address));
    console.log("after USDT Balance: " + await USDT.balanceOf(account.address));
    const after = await USDT.balanceOf(account.address);

    console.log("Result: " + ethers.BigNumber.from(after).sub(ethers.BigNumber.from(before)).toString());
}

const getTransactionCost = async (txResult) => {
    const cumulativeGasUsed = (await txResult.wait()).cumulativeGasUsed;
    return ethers.BigNumber.from(txResult.gasPrice).mul(ethers.BigNumber.from(cumulativeGasUsed));
  };

async function main() {
    await executeWETH2RND();
}

main()
    .then(() => process.exit(0))
    .catch(error => {
        console.error(error);
        process.exit(1);
    });
