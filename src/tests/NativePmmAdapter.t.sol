pragma solidity 0.8.17;

import "forge-std/test.sol";
import "@dex/DexRouter.sol";

import "@dex/adapter/NativePmmAdapter.sol";

contract NativePmmAdapterTest is Test {
    address constant ETH = address(0);
    address constant WETH = 0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2;
    address constant USDT = 0xdAC17F958D2ee523a2206206994597C13D831ec7;

    function test_tradeNativePmm() public {
        vm.createSelectFork("https://eth.llamarpc.com");
        vm.warp(1732269052);

        vm.etch(
            0xbf381E1cBfdb0D02F3800010e490130D3dC73118,
            address(new NativePmmAdapter(WETH)).code
        );

        NativePmmAdapter adapter = NativePmmAdapter(
            payable(address(0xbf381E1cBfdb0D02F3800010e490130D3dC73118))
        );

        // {
        //   "quote": {
        //     "amountOutMinimum": "33427124",
        //     "buyerToken": "0xdac17f958d2ee523a2206206994597c13d831ec7",
        //     "buyerTokenAmount": "33595100",
        //     "deadlineTimestamp": "1732269052",
        //     "effectiveSellerTokenAmount": "10000000000000000",
        //     "externalSwapCalldata": "0x",
        //     "multiHop": false,
        //     "nonce": "2434815677256441",
        //     "pool": "0x28cacd5e26a719f139e2105ca1efc3d9dc892826",
        //     "quoteId": "0x0055ce4c29404f7d9afd2d2ac6e48815",
        //     "recipient": "0xbf381e1cbfdb0d02f3800010e490130d3dc73118",
        //     "sellerToken": "0x0000000000000000000000000000000000000000",
        //     "sellerTokenAmount": "10000000000000000",
        //     "signature": "0xb6f7d1a1b01bd560b2869193f9a9bad4a4db802228ca5d0f254bd50b973a4e040fff16b3458ab4455ac99dbb157a915fe77065592b01e27da4f16f300d3fab231c",
        //     "signer": "0xff8ba4d1fc3762f6154cc942ccf30049a2a0cec6",
        //     "widgetFee": {
        //       "feeRate": "0",
        //       "feeRecipient": "0x60cba82ddbf4b5ddcd4398cdd05354c6a790c309",
        //       "signer": "0x67297ee4eb097e072b4ab6f1620268061ae80464"
        //     },
        //     "widgetFeeSignature": "0xf0d1f3b1dbdec49d889edfa0dd13aac9c5f747d3c10eae14e044ae6bbb129c71246fa9ce842029b0532758b50f9b33fe61758ce573174d98bbc456f8bb51f9001b"
        //   }
        // }
        INativeRfqPool.RFQTQuote memory quote = INativeRfqPool.RFQTQuote({
            pool: 0x28caCD5e26A719f139e2105ca1efc3D9Dc892826,
            signer: 0xff8Ba4D1fC3762f6154cc942CCF30049A2A0cEC6,
            recipient: 0xbf381E1cBfdb0D02F3800010e490130D3dC73118,
            sellerToken: ETH,
            buyerToken: USDT,
            effectiveSellerTokenAmount: 0.01 ether, // 0.01 ETH
            sellerTokenAmount: 0.01 ether,
            buyerTokenAmount: 33595100, // ~33.59 USDT
            deadlineTimestamp: 1732269052,
            externalSwapCalldata: "",
            multiHop: false,
            nonce: 2434815677256441,
            quoteId: bytes16(0x0055ce4c29404f7d9afd2d2ac6e48815),
            signature: hex"b6f7d1a1b01bd560b2869193f9a9bad4a4db802228ca5d0f254bd50b973a4e040fff16b3458ab4455ac99dbb157a915fe77065592b01e27da4f16f300d3fab231c",
            widgetFee: INativeRfqPool.WidgetFee({
                feeRate: 0,
                feeRecipient: 0x60CBA82DdBf4b5dDcd4398cDd05354C6A790C309,
                signer: 0x67297EE4Eb097e072B4AB6F1620268061Ae80464
            }),
            widgetFeeSignature: hex"f0d1f3b1dbdec49d889edfa0dd13aac9c5f747d3c10eae14e044ae6bbb129c71246fa9ce842029b0532758b50f9b33fe61758ce573174d98bbc456f8bb51f9001b",
            amountOutMinimum: 33427124
        });
        deal(WETH, address(adapter), 0.01 ether);
        adapter.sellBase(
            address(this),
            0xEAd050515E10fDB3540ccD6f8236C46790508A76,
            // abi.encode(quote)
            hex"000000000000000000000000000000000000000000000000000000000000002000000000000000000000000028cacd5e26a719f139e2105ca1efc3d9dc892826000000000000000000000000ff8ba4d1fc3762f6154cc942ccf30049a2a0cec6000000000000000000000000bf381e1cbfdb0d02f3800010e490130d3dc731180000000000000000000000000000000000000000000000000000000000000000000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec7000000000000000000000000000000000000000000000000002386f26fc10000000000000000000000000000000000000000000000000000002386f26fc100000000000000000000000000000000000000000000000000000000000002009edc00000000000000000000000000000000000000000000000000000000674053fc0000000000000000000000000000000000000000000000000008a673b38952f90055ce4c29404f7d9afd2d2ac6e48815000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000026000000000000000000000000067297ee4eb097e072b4ab6f1620268061ae8046400000000000000000000000060cba82ddbf4b5ddcd4398cdd05354c6a790c309000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002e000000000000000000000000000000000000000000000000000000000000003600000000000000000000000000000000000000000000000000000000001fe0eb40000000000000000000000000000000000000000000000000000000000000041b6f7d1a1b01bd560b2869193f9a9bad4a4db802228ca5d0f254bd50b973a4e040fff16b3458ab4455ac99dbb157a915fe77065592b01e27da4f16f300d3fab231c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000041f0d1f3b1dbdec49d889edfa0dd13aac9c5f747d3c10eae14e044ae6bbb129c71246fa9ce842029b0532758b50f9b33fe61758ce573174d98bbc456f8bb51f9001b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
        );
    }
}
